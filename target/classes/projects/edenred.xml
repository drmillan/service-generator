<protocol 
    javaServiceException="es.edenred.logic.ServiceException"
    javaServiceExceptionListener="es.edenred.logic.ServiceExceptionListener"
    
    onSend="es.edenred.EdenredApplication.onSend" onReceive="es.edenred.EdenredApplication.onReceive" onError="es.edenred.EdenredApplication.onError" onTask="es.edenred.EdenredApplication.onTaskFinished">
	<messages>
	    <!-- Para tests: loginRoot: https://dl.dropbox.com/u/40520375/Edenred -->
	    <!-- Para tests: searchRoot: http://edenredapi.apiary.io -->
		<!-- ###################################### LOGIN ###################################### -->
		<message name="Login" service="User" method="login" description="" type="Get">
		    <urlPattern>
				<url address="https://preprod-webservices.edenred.es/WSApp/AppService.asmx/Login?user=${user}&amp;password=${password}&amp;positions=${positions}&amp;datePositions=${datePositions}" />				
			</urlPattern>			
			<request name="LoginRequestDTO">
			    <field name="user" type="String" description="usuario de login"/>
			    <field name="password" type="String" description="Password cifrado con la función SHA256"/>
			    <field name="positions" type="String" description="String formado por 3 cifras separadas por ‘,’ comas. Que correspondan a la fecha secreta." />
				<field name="datePositions" type="String" description="String formado por 3 cifras separadas por ‘,’ comas. Que corresponden a los datos introducidos en las posiciones mandadas en el anterior parámetro."></field>
			</request>
			<response name="LoginResponseDTO">
			    <field name="error" type="ErrorResponseDTO" description=""/>
			    <field name="response" type="boolean" description="Boolean"/>
			    <field name="products" type="ProductsResponseDTO*" description="Array de ProductsResponseDTO"/>
			</response>
		</message>
		<!-- ###################################### SALDO ###################################### -->
		<message name="Amount" service="User" method="amount" description="" type="Get">
		    <urlPattern>
				<url address="https://preprod-webservices.edenred.es/WSApp/AppService.asmx/ConsultaSaldo?user=${user}&amp;password=${password}&amp;idTicket=${idTicket}" />				
			</urlPattern>			
			<request name="AmountRequestDTO">
			    <field name="user" type="String" description="usuario de login"/>
			    <field name="password" type="String" description="Password cifrado con la función SHA256"/>
			    <field name="idTicket" type="int" description="idTicket sacado del ProductsResponse para la tarjeta seleccionada" />
			</request>
			<response name="AmountResponseDTO">
			    <field name="error" type="ErrorResponseDTO" description=""/>
			    <field name="balance" type="double" description="Saldo"/>
			</response>
		</message>	
		<!-- ###################################### TRANSACCIONES ###################################### -->
		<message name="TransactionsLog" service="User" method="transactionsLog" description="" type="Get">
		    <urlPattern>
				<url address="https://preprod-webservices.edenred.es/WSApp/AppService.asmx/HistoricoTransacciones?user=${user}&amp;password=${password}&amp;idTicket=${idTicket}" />				
			</urlPattern>			
			<request name="TransactionLogRequestDTO">
			    <field name="user" type="String" description="usuario de login"/>
			    <field name="password" type="String" description="Password cifrado con la función SHA256"/>
			    <field name="idTicket" type="int" description="idTicket sacado del ProductsResponse para la tarjeta seleccionada" />
			</request>
			<response name="TransactionLogResponseDTO">
			    <field name="error" type="ErrorResponseDTO" description=""/>
			    <field name="transactions" type="TransactionDTO*" description="Histórico de transacciones"/>
			</response>
		</message>			
		<!-- ###################################### RECORDAR PIN ###################################### -->
		<message name="RecoverPin" service="User" method="recoverPin" description="" type="Get">
		    <urlPattern>
				<url address="https://preprod-webservices.edenred.es/WSApp/AppService.asmx/RecordarPIN?user=${user}&amp;password=${password}&amp;idTicket=${idTicket}" />				
			</urlPattern>			
			<request name="RecoverPinRequestDTO">
			    <field name="user" type="String" description="usuario de login"/>
			    <field name="password" type="String" description="Password cifrado con la función SHA256"/>
			    <field name="idTicket" type="int" description="idTicket sacado del ProductsResponse para la tarjeta seleccionada" />
			</request>
			<response name="RecoverPinResponseDTO">
			    <field name="error" type="ErrorResponseDTO" description=""/>
			    <field name="code" type="String" description="Codigo pin"/>
			</response>
		</message>			
		<!-- ###################################### ANULAR TARJETA ###################################### -->
		<message name="CancelCard" service="User" method="cancelCard" description="" type="Get">
		    <urlPattern>
				<url address="https://preprod-webservices.edenred.es/WSApp/AppService.asmx/AnularTarjeta?user=${user}&amp;password=${password}&amp;idTicket=${idTicket}&amp;reason=${reason}" />				
			</urlPattern>			
			<request name="CancelCardRequestDTO">
			    <field name="user" type="String" description="usuario de login"/>
			    <field name="password" type="String" description="Password cifrado con la función SHA256"/>
			    <field name="idTicket" type="int" description="idTicket sacado del ProductsResponse para la tarjeta seleccionada" />
				<field name="reason" type="String" description="Tiene que ser STOLEN, DAMAGED o LOST" />
			</request>
			<response name="CancelCardResponseDTO">
			    <field name="error" type="ErrorResponseDTO" description=""/>
			    <field name="response" type="Boolean" description="Indica si se ha cancelado la tarjeta o no"/>
			</response>
		</message>				
		<!-- ###################################### PROMOTIONS ################################# -->
		<message name="Promotions" service="Promotion" method="getPromotions" description="Obtener lista de promociones" type="Get">
			<urlPattern>
				<url address="http://prod-plat-beneficioclub.geaportal.com/ACCOR_ADMIN/SRV_WEBMOBILE/WMBeneficioClubCGI.php?command=getPromociones&amp;code=${code}" />
			</urlPattern>
			<request name="PromotionsRequestDTO">
			    <field name="code" type="string"/>
			    <!-- 
			    <field name="id_promo" type="String" description=""/>
			    <field name="name_promo" type="String" description=""/>
			    <field name="name_restaurant" type="String" description=""/>
			    <field name="id_restaurant" type="String" description=""/>
			    <field name="gustino" type="int" description=""/>
			    <field name="zip" type="String" description=""/>
			    <field name="address" type="String" description=""/>
			    <field name="type" type="String" description=""/>
			    <field name="town" type="String" description=""/>
			     -->			    			    
			</request>
			<response name="PromotionsResponseDTO">
			    <!-- PREINJECTED -->
			    <field name="items" type="PromotionDTO*"/>			    
			</response>
		</message>		
		<!-- ###################################### LISTADO DE AFILIADOS ###################################### -->
		<message name="AffiliateSearch" service="Affiliates" method="affiliateSearch" description="Devuelve una lista de afiliados por proximidad geografica" type="Get">
		    <urlPattern>
				<url address="${searchRoot}/api/v1/affiliate_search?producto=${producto}&amp;formato=${formato}&amp;affiliate=${affiliate}&amp;center_lat=${center_lat}&amp;center_lng=${center_lng}&amp;limit_lat=${limit_lat}&amp;limit_lng=${limit_lng}&amp;gustino=${gustino}&amp;promotions=${promotions}&amp;page=${page}" />				
			</urlPattern>			
			<request name="AffiliateSearchRequestDTO">
			    <field name="producto" type="String" description="Tipo de afiliado a buscar [ticket-restaurant | ticket-guarderia | ticket-compliments]"/>
			    <field name="formato" type="String" description="Formato del ticket. Para ticket guarderia [papel | online], para ticket restaurante [papel | tarjeta]"/>
			    <field name="affiliate" type="String" description="Nombre del afiliado en el formulario" />
				<field name="center_lat" type="Double" description="Latitud del centro de la busqueda" />
				<field name="center_lng" type="Double" description="Longitud del centro de la busqueda" />
				<field name="limit_lat" type="Double" description="Latitud del limite de la busqueda" />
				<field name="limit_lng" type="Double" description="Longitud del limite de la busqueda" />
				<field name="gustino" type="Boolean" description="Si esta a true sólo busca afliados con Gustino. Cualquier otro valor se ignora"/>
				<field name="promotions" type="Boolean" description="Si esta a true sólo busca afliados con promociones. Cualquier otro valor se ignora"/>
				<field name="page" type="int" description="Pagina a devolver de la lista de resultados" />
			</request>
			<response name="AffiliateSearchResponseDTO">
			    <field name="page" type="int" description="Numero de pagina actual"/>
			    <field name="total_pages" type="int" description="Numero de pagina total"/>
			    <field name="affiliate_searches" type="AffiliateSearchWrapperDTO*" description="Informacion de busqueda"/>
			</response>
		</message>		
		<!-- ###################################### LISTADO DE AFILIADOS POR CALLE ###################################### -->
		<message name="AdvancedAffiliateSearch" service="Affiliates" method="advancedAffiliateSearch" description="Devuelve una lista de afiliados por proximidad geografica" type="Get">
		    <urlPattern>
				<url address="${searchRoot}/api/v1/affiliate_search/advanced?producto=${producto}&amp;formato=${formato}&amp;affiliate=${affiliate}&amp;province=${province}&amp;city=${city}&amp;address_type=${address_type}&amp;address_name=${address_name}&amp;address_number=${address_number}&amp;address_cp=${address_cp}&amp;gustino=${gustino}&amp;promotions=${promotions}&amp;page=${page}" />				
			</urlPattern>			
			<request name="AdvancedAffiliateSearchRequestDTO">
			    <field name="producto" type="String" description="Tipo de afiliado a buscar [ticket-restaurant | ticket-guarderia | ticket-compliments]"/>
			    <field name="formato" type="String" description="Formato del ticket. Para ticket guarderia [papel | online], para ticket restaurante [papel | tarjeta]"/>
			    <field name="affiliate" type="String" description="Nombre del afiliado en el formulario" />
				<field name="province" type="String" description="Nombre de la provincia. Si no se especifica se busca en todas." />
				<field name="city" type="String" description="Nombre de la ciudad. Si no se especifica se busca en todas." />
				<field name="address_type" type="String" description="Tipo de via. Si no se especifica se busca en todas." />
				<field name="address_name" type="String" description="Nombre de la calle. Si no se especifica se busca en todas." />
				<field name="address_number" type="String" description="Numero de portal. Si no se especifica se busca en todos." />
				<field name="address_cp" type="String" description="Codigo postal. Si no se especifica se busca en todos." />
			    <field name="gustino" type="Boolean" description="Si esta a true sólo busca afliados con Gustino. Cualquier otro valor se ignora"/>
				<field name="promotions" type="Boolean" description="Si esta a true sólo busca afliados con promociones. Cualquier otro valor se ignora"/>
				<field name="page" type="int" description="Pagina a devolver de la lista de resultados" />
			</request>
			<response name="AdvancedAffiliateSearchResponseDTO">
			    <field name="page" type="int" description="Numero de pagina actual"/>
			    <field name="total_pages" type="int" description="Numero de pagina total"/>
			    <field name="affiliate_searches" type="AffiliateSearchWrapperDTO*" description="Informacion de busqueda"/>
			</response>
		</message>			
		<!-- ###################################### CREAR INDICENCIA ###################################### -->
		<message name="ReportProblem" service="Affiliates" method="reportProblem" description="Levanta una incidencia sobre un afiliado" type="PostJSON">
		    <urlPattern>
				<url address="${searchRoot}/api/v1/affiliate_comment" />				
			</urlPattern>			
			<request name="ReportProblemRequestDTO">
			    <field name="affiliate_comment" type="ProblemDTO" description="Incidencia que se quiere levantar"/>
			</request>
			<response name="ReportProblemResponseDTO">
			    <field name="error" type="String*" description="Errores reportados (tambien se recibira un codigo HTTP 422 si hay un error)"/>
				<field name="affiliate_comment" type="ProblemDTO" description="Incidencia levantada (si HTTP 200)" />
			</response>
		</message>		
		<!-- ###################################### DETALLE DE UN AFILIADO ###################################### -->
		<message name="AffiliateDetails" service="Affiliates" method="affiliateDetails" description="Obtiene los detalles de un afiliado" type="Get">
		    <urlPattern>
				<url address="${searchRoot}/api/v1/affiliate_search/${affiliateId}" />				
			</urlPattern>			
			<request name="AffiliateDetailsRequestDTO">
			    <field name="affiliateId" type="String" description="Codigo del afiliado del que queremos los datos"/>
			</request>
			<response name="AffiliateDetailsResponseDTO">
			    <field name="affiliate_searches" type="AffiliateSearchWrapperDTO*" description="Detalle de los afiliados encontrados con ese id8"/>
			</response>
		</message>	
							
	</messages>
	
	<types>
	    <type name="ProblemDTO">
	        <!-- <field name="id" type="int" description="ID de la incidencia" /> -->
	        <field name="affiliate_id" type="int" description="Codigo del afiliado en Edenred" />
	        <field name="affiliate_type" type="String" description="Tipo de producto del afiliado. (TicketRestaurant, Kindergarten, ComplimentsAffiliate)" />
	        <field name="comment_type" type="String" description="Tipo de la incidencia. (closed | wrong_location | wrong_address | tickets_restricted | card_restricted | other)" />
	        <field name="email" type="String" description="Email del usuario con formato valido" />
	        <field name="comment" type="String" description="Texto explicativo de la incidencia" />
	        <field name="terms_of_service" type="String" description="Este valor debe ser siempre 1 y ha de solicitarse una confirmacion al usuario antes de enviar la incidencia" />
	    </type>
	    
	    <type name="AffiliateSearchWrapperDTO">
	        <field name="affiliate_search" type="AffiliateSearchDetailDTO" description="Datos de afiliado" />
	    </type>
	    
	    <type name="AffiliateSearchDetailDTO">
	        <field name="affiliate_type" type="String" description="Producto del afiliado encontrado (TicketRestaurant, Kindergarten, ComplimentsAffiliate)" />
	        <field name="address" type="AddressDTO" description="Datos de la direccion" />
	        <field name="affiliate" type="AffiliateDTO" description="Datos del afiliado" />
	    </type>
	    
	    <type name="AddressDTO">
	        <field name="country" type="String" description="Pais" />
	        <field name="city" type="String" description="Ciudad" />
	        <field name="province" type="String" description="Provincia" />
	        <field name="name" type="String" description="Nombre de la calle" />
	        <field name="type" type="String" description="Tipo de la via" />
	        <field name="number" type="String" description="Numero del portal" />
	        <field name="postal_code" type="String" description="Codigo postal" />
	        <field name="latitude" type="Double" description="Latitud" />
	        <field name="longitude" type="Double" description="Longitud" />	        	        	        	        	        
	    </type>
	    
	    <type name="AffiliateDTO">
	        <field name="name" type="String" description="Nombre del establecimiento" />
	        <field name="number" type="String" description="Identificador del afiliado en el sistema de Edenred" />
	        <field name="phone" type="String" description="Telefono del establecimiento" />
	        <field name="restaurant_paper" type="Boolean" description="Indica si el establecimiento acepta formato papel (solo para ticket-restaurant)" />
	        <field name="card" type="Boolean" description="Indica si el establecimiento acepta formato tarjeta (solo para ticket-restaurant y ticket-guardería)." />
	        <field name="direct" type="Boolean" description="Indica si el establecimiento acepta pago con tarjeta guardería"/>
	        <field name="kinder_paper" type="Boolean" description="Indica si el establecimiento acepta formato papel (solo para ticket-guardería)." />
	        <field name="gustino" type="Boolean" description="Indica si el establecimiento está afiliado a al plan Gustino (solo para ticket-restaurant)." />
	        <field name="promotions" type="Boolean" description="Indica si el establecimiento tiene promociones (solo para ticket-restaurant)." />
	        <field name="food_type" type="String" description="Tipo de cocina, si no esta especificada el valor es null (solo para ticket-restaurant)." />
	        <field name="compliment_type" type="Boolean" description="Tipo de establecimiento, si no esta especificado el valor es null (solo para ticket-compliments)." />	        	        	        	        
	    </type>
	    
		<type name="ErrorResponseDTO">
	        <field name="errorCode" type="int" description=""/>
	        <field name="errorDescription" type="String" description=""/>
	    </type>
	    
	    <type name="ProductsResponseDTO">
	        <field name="serialNumber" type="String" description="número de serie del producto (10 cifras). Vendrá siempre informado excepto para Ticket Restaurant Card de 4B."/>
	        <field name="cardNumber" type="String" description="4 últimas cifras de la tarjeta. Solo vendrá informado cuando sea Ticket Restaurant Card 4B. en los demás casos vendrá vacío "/>
	    	<field name="productType" type="ProductTypeResponseDTO" description=""/>
	    	<field name="idTicket" type="int" description=""/>
	    </type>
	    
	    <type name="ProductTypeResponseDTO">
	        <field name="idProductType" type="int" description=""/>
	        <field name="ProductTypeDescription" type="String" description=" [TICKET RESTAURANT, TICKET CORPORATE, TICKET TRANSPORTE, TICKET REGALO, TICKET REGALO PREMIUM]"/>
	    </type>

		<type name="TransactionDTO">
	        <field name="date" type="Long" description="Fecha de la transaccion"/>
	        <field name="description" type="String" description="Nombre de la tienda"/>
	        <field name="amount" type="Double" description="Dinero gastado"/>
	    </type>
	    
	    <type name="RestaurantDTO">
	        <field name="ID" type="String" description=""/>
	        <field name="RESTAURANTE_NAME" type="String" description=""/>
	        <field name="TOWN" type="String" description=""/>
	        <field name="TYPE" type="String" description=""/>
	        <field name="ADDRESS_NAME" type="String" description=""/>
	        <field name="ZIP" type="String" description=""/>
	        <field name="GUSTINO" type="String" description=""/>
	    </type>	    	    
	    <type name="PromotionDTO">
			<field name="PROMO_ID" type="String" description=""/>
			<field name="PROMO_NAME" type="String" description=""/>
			<field name="PROMO_STATUS" type="String" description=""/>
			<field name="DATE_SINCE" type="Date" description=""/>
			<field name="DATE_UNTIL" type="Date" description=""/>
			<field name="DESCRIPTION" type="String" description=""/>
			<field name="CONDITIONS" type="String" description=""/>
			<field name="PROMO_URL" type="String" description=""/>
			<field name="RESTAURANTES" type="RestaurantDTO*" description=""/>
	    </type>
	</types>
</protocol>